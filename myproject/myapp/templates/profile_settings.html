{% extends 'base.html' %}
{% load static %}
{% block meta_description %}จัดการโปรไฟล์และที่อยู่ของคุณกับ IMSUK เพื่อสั่งอาหารสะดวกยิ่งขึ้น{% endblock %}
{% block meta_keywords %}IMSUK, โปรไฟล์, ที่อยู่, ลดขยะอาหาร{% endblock %}
{% block title %}<span class="imsuk-bold">IMSUK</span> - การตั้งค่าโปรไฟล์{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" integrity="sha512-c42qTSw/wPZ3/5LBzD+Bw5f7bSF2oxou6wEb+I/lqeaKV5FDIfMvvRp772y4jcJLKuGUOpbJMdg/BTl50fJYAw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
{% endblock %}
{% block content %}
<div class="container my-4">
    <!-- Profile Information -->
    <div class="card p-4 animate__animated animate__fadeIn">
        <h2 class="h4 fw-bold mb-4" style="color: var(--imsuk-primary);">ข้อมูลส่วนตัว</h2>
        <form method="post" id="profileForm">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="profile">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="first_name" class="form-label">ชื่อ</label>
                    <input type="text" name="first_name" id="first_name" class="form-control" value="{{ user.first_name|default:"" }}" required>
                </div>
                <div class="col-md-6">
                    <label for="last_name" class="form-label">นามสกุล</label>
                    <input type="text" name="last_name" id="last_name" class="form-control" value="{{ user.last_name|default:"" }}" required>
                </div>
                <div class="col-md-6">
                    <label for="phone_number" class="form-label">เบอร์โทรศัพท์</label>
                    <input type="tel" name="phone_number" id="phone_number" class="form-control" value="{{ user.profile.phone_number|default:"" }}" pattern="[0-9]{10}" required>
                </div>
            </div>
            <div class="text-end mt-3">
                <button type="submit" class="btn btn-pink">บันทึก</button>
            </div>
        </form>
    </div>

    <!-- Address Management -->
    <div class="card p-4 animate__animated animate__fadeInUp">
        <h2 class="h4 fw-bold mb-3" style="color: var(--imsuk-primary);">ที่อยู่</h2>
        <form method="post" id="addressForm" class="mb-4">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="address">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="label" class="form-label">ชื่อที่อยู่</label>
                    <input type="text" name="label" id="label" class="form-control" placeholder="เช่น บ้าน, ที่ทำงาน" required>
                </div>
                <div class="col-md-6">
                    <label for="address_line" class="form-label">ที่อยู่</label>
                    <input type="text" name="address_line" id="address_line" class="form-control" placeholder="เลขที่, หมู่บ้าน, ถนน" required>
                </div>
                <div class="col-md-6">
                    <label for="subdistrict" class="form-label">ตำบล/แขวง</label>
                    <input type="text" name="subdistrict" id="subdistrict" class="form-control" required>
                </div>
                <div class="col-md-6">
                    <label for="district" class="form-label">อำเภอ/เขต</label>
                    <input type="text" name="district" id="district" class="form-control" required>
                </div>
                <div class="col-md-6">
                    <label for="province" class="form-label">จังหวัด</label>
                    <input type="text" name="province" id="province" class="form-control" required>
                </div>
                <div class="col-md-6">
                    <label for="postal_code" class="form-label">รหัสไปรษณีย์</label>
                    <input type="text" name="postal_code" id="postal_code" class="form-control" pattern="[0-9]{5}" required>
                </div>
                <div class="col-md-6">
                    <label for="phone_number" class="form-label">เบอร์โทรศัพท์</label>
                    <input type="tel" name="phone_number" id="phone_number_address" class="form-control" pattern="[0-9]{10}" required>
                </div>
                <div class="col-md-6">
                    <div class="form-check mt-3">
                        <input type="checkbox" class="form-check-input" id="is_default" name="is_default">
                        <label class="form-check-label" for="is_default">ตั้งเป็นที่อยู่เริ่มต้น</label>
                    </div>
                </div>
            </div>
            <div class="text-end mt-3">
                <button type="submit" class="btn btn-pink">เพิ่มที่อยู่</button>
            </div>
        </form>
        <div class="row g-3">
            {% for address in addresses %}
            <div class="col-md-6">
                <div class="card p-3 position-relative">
                    <h6 class="fw-bold mb-2">{{ address.label }} {% if address.is_default %}<span class="badge bg-success">เริ่มต้น</span>{% endif %}</h6>
                    <p class="text-muted small">
                        {{ address.address_line }}<br>
                        ต.{{ address.subdistrict }} อ.{{ address.district }}<br>
                        จ.{{ address.province }} {{ address.postal_code }}<br>
                        โทร: {{ address.phone_number }}
                    </p>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-imsuk btn-sm edit-address" data-address-id="{{ address.id }}" data-bs-toggle="modal" data-bs-target="#editAddressModal">แก้ไข</button>
                        <form method="post" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="delete_address">
                            <input type="hidden" name="address_id" value="{{ address.id }}">
                            <button type="submit" class="btn btn-pink btn-sm" onclick="return confirm('คุณแน่ใจหรือไม่ว่าต้องการลบที่อยู่นี้?');"><i class="fas fa-trash"></i> ลบ</button>
                        </form>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12">
                <p class="text-muted text-center py-3">ยังไม่มีที่อยู่ กรุณาเพิ่มที่อยู่ด้านบน</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Allergens -->
    <div class="card p-4 animate__animated animate__fadeInUp">
        <h2 class="h4 fw-bold mb-3" style="color: var(--imsuk-primary);">สารก่อภูมิแพ้</h2>
        <form method="post" id="allergyForm">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="allergy">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="allergy_name" class="form-label">เพิ่มสารก่อภูมิแพ้</label>
                    <input type="text" name="allergy_name" id="allergy_name" class="form-control" placeholder="เช่น ถั่วลิสง, นม" required>
                </div>
            </div>
            <div class="text-end mt-3">
                <button type="submit" class="btn btn-pink">เพิ่ม</button>
            </div>
        </form>
        <div class="mt-3">
            {% for allergy in allergies %}
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                <span class="text-muted">{{ allergy.name }}</span>
                <form method="post" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="delete_allergy">
                    <input type="hidden" name="allergy_id" value="{{ allergy.id }}">
                    <button type="submit" class="btn btn-link text-muted btn-sm" onclick="return confirm('คุณแน่ใจหรือไม่ว่าต้องการลบสารก่อภูมิแพ้นี้?');"><i class="fas fa-times"></i></button>
                </form>
            </div>
            {% empty %}
            <p class="text-muted text-center py-3">ยังไม่มีสารก่อภูมิแพ้</p>
            {% endfor %}
        </div>
    </div>

    <!-- Edit Address Modal -->
    <div class="modal fade" id="editAddressModal" tabindex="-1" aria-labelledby="editAddressModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background-color: var(--imsuk-secondary);">
                    <h5 class="modal-title" id="editAddressModalLabel" style="color: var(--imsuk-primary);">แก้ไขที่อยู่</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post" id="editAddressForm">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="edit_address">
                        <input type="hidden" name="address_id" id="edit_address_id">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="edit_label" class="form-label">ชื่อที่อยู่</label>
                                <input type="text" name="label" id="edit_label" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label for="edit_address_line" class="form-label">ที่อยู่</label>
                                <input type="text" name="address_line" id="edit_address_line" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label for="edit_subdistrict" class="form-label">ตำบล/แขวง</label>
                                <input type="text" name="subdistrict" id="edit_subdistrict" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label for="edit_district" class="form-label">อำเภอ/เขต</label>
                                <input type="text" name="district" id="edit_district" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label for="edit_province" class="form-label">จังหวัด</label>
                                <input type="text" name="province" id="edit_province" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label for="edit_postal_code" class="form-label">รหัสไปรษณีย์</label>
                                <input type="text" name="postal_code" id="edit_postal_code" class="form-control" pattern="[0-9]{5}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="edit_phone_number" class="form-label">เบอร์โทรศัพท์</label>
                                <input type="tel" name="phone_number" id="edit_phone_number" class="form-control" pattern="[0-9]{10}" required>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mt-3">
                                    <input type="checkbox" class="form-check-input" id="edit_is_default" name="is_default">
                                    <label class="form-check-label" for="edit_is_default">ตั้งเป็นที่อยู่เริ่มต้น</label>
                                </div>
                            </div>
                        </div>
                        <div class="text-end mt-3">
                            <button type="submit" class="btn btn-pink">บันทึก</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const editButtons = document.querySelectorAll('.edit-address');
    const toast = new bootstrap.Toast(document.getElementById('cartToast'));

    editButtons.forEach(button => {
        button.addEventListener('click', function() {
            const addressId = this.getAttribute('data-address-id');
            fetch(`/api/address/${addressId}/`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                document.getElementById('edit_address_id').value = addressId;
                document.getElementById('edit_label').value = data.label;
                document.getElementById('edit_address_line').value = data.address_line;
                document.getElementById('edit_subdistrict').value = data.subdistrict;
                document.getElementById('edit_district').value = data.district;
                document.getElementById('edit_province').value = data.province;
                document.getElementById('edit_postal_code').value = data.postal_code;
                document.getElementById('edit_phone_number').value = data.phone_number;
                document.getElementById('edit_is_default').checked = data.is_default;
            })
            .catch(error => {
                console.error('Error fetching address:', error);
                toast.querySelector('.toast-body').textContent = 'ไม่สามารถโหลดข้อมูลที่อยู่ได้ กรุณาลองใหม่';
                toast.classList.add('bg-danger', 'text-white');
                toast.show();
            });
        });
    });
});
</script>
{% endblock %}